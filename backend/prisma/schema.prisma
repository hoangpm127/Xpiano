// Prisma Schema for Xpiano MVP
// Database: PostgreSQL with PostGIS

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [postgis(schema: "public")]
}

// ============================================
// USERS & AUTH
// ============================================

enum UserRole {
  student
  teacher
  partner
  admin
}

model User {
  id         String    @id @default(uuid()) @db.Uuid
  phone      String    @unique @db.VarChar(15)
  email      String?   @unique @db.VarChar(255)
  fullName   String    @map("full_name") @db.VarChar(255)
  avatarUrl  String?   @map("avatar_url") @db.VarChar(500)
  role       UserRole  @default(student)
  
  // Affiliate
  referrerId   String? @map("referrer_id") @db.Uuid
  referrer     User?   @relation("Referrals", fields: [referrerId], references: [id], onDelete: SetNull)
  referredUsers User[] @relation("Referrals")
  referralCode String? @unique @map("referral_code") @db.VarChar(20)
  affiliateTier Int    @default(0) @map("affiliate_tier")
  
  // Status
  isActive   Boolean   @default(true) @map("is_active")
  isVerified Boolean   @default(false) @map("is_verified")
  
  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  lastLoginAt DateTime? @map("last_login_at") @db.Timestamptz(6)
  
  // Relations
  wallet           Wallet?
  teacherProfile   TeacherProfile?
  warehouses       Warehouse[]
  ordersAsStudent  Order[]            @relation("StudentOrders")
  sessionsAsStudent ClassSession[]    @relation("StudentSessions")
  sessionsAsTeacher ClassSession[]    @relation("TeacherSessions")
  commissionsEarned Commission[]      @relation("AffiliateCommissions")
  commissionsSource Commission[]      @relation("SourceCommissions")
  
  @@index([referrerId])
  @@index([referralCode])
  @@index([role])
  @@map("users")
}

// ============================================
// WALLETS & TRANSACTIONS
// ============================================

model Wallet {
  id             String  @id @default(uuid()) @db.Uuid
  userId         String  @unique @map("user_id") @db.Uuid
  user           User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  balance        Decimal @default(0) @db.Decimal(15, 2)
  pendingBalance Decimal @default(0) @map("pending_balance") @db.Decimal(15, 2)
  totalEarned    Decimal @default(0) @map("total_earned") @db.Decimal(15, 2)
  totalWithdrawn Decimal @default(0) @map("total_withdrawn") @db.Decimal(15, 2)
  
  currency       String  @default("VND") @db.VarChar(3)
  
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  transactions   WalletTransaction[]
  
  @@index([userId])
  @@map("wallets")
}

enum TransactionType {
  commission
  withdrawal
  refund
  bonus
  adjustment
}

enum TransactionDirection {
  credit
  debit
}

enum TransactionStatus {
  pending
  completed
  failed
  reversed
}

model WalletTransaction {
  id            String               @id @default(uuid()) @db.Uuid
  walletId      String               @map("wallet_id") @db.Uuid
  wallet        Wallet               @relation(fields: [walletId], references: [id], onDelete: Cascade)
  
  type          TransactionType
  direction     TransactionDirection
  amount        Decimal              @db.Decimal(12, 2)
  balanceBefore Decimal              @map("balance_before") @db.Decimal(15, 2)
  balanceAfter  Decimal              @map("balance_after") @db.Decimal(15, 2)
  
  referenceType String?              @map("reference_type") @db.VarChar(50)
  referenceId   String?              @map("reference_id") @db.Uuid
  description   String?              @db.Text
  
  status        TransactionStatus    @default(completed)
  createdAt     DateTime             @default(now()) @map("created_at") @db.Timestamptz(6)
  
  @@index([walletId])
  @@index([type])
  @@index([createdAt(sort: Desc)])
  @@map("wallet_transactions")
}

// ============================================
// WAREHOUSES & PIANOS
// ============================================

model Warehouse {
  id         String   @id @default(uuid()) @db.Uuid
  partnerId  String   @map("partner_id") @db.Uuid
  partner    User     @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  
  name       String   @db.VarChar(255)
  address    String   @db.Text
  district   String?  @db.VarChar(100)
  city       String   @db.VarChar(100)
  
  // PostGIS location - stored as unsupported type in Prisma
  // Use raw SQL for spatial queries
  lat        Decimal  @db.Decimal(10, 8)
  lng        Decimal  @db.Decimal(11, 8)
  
  phone      String?  @db.VarChar(15)
  email      String?  @db.VarChar(255)
  
  // Inventory (denormalized)
  totalPianos     Int @default(0) @map("total_pianos")
  availablePianos Int @default(0) @map("available_pianos")
  rentedPianos    Int @default(0) @map("rented_pianos")
  
  openingTime String @default("08:00") @map("opening_time") @db.Time(6)
  closingTime String @default("21:00") @map("closing_time") @db.Time(6)
  
  isActive    Boolean @default(true) @map("is_active")
  avgRating   Decimal @default(0) @map("avg_rating") @db.Decimal(2, 1)
  totalReviews Int    @default(0) @map("total_reviews")
  
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  pianos      Piano[]
  orders      Order[]
  
  @@index([partnerId])
  @@index([city])
  @@map("warehouses")
}

enum PianoStatus {
  available
  rented
  maintenance
  retired
}

enum PianoCondition {
  new
  excellent
  good
  fair
  poor
}

model Piano {
  id            String         @id @default(uuid()) @db.Uuid
  warehouseId   String         @map("warehouse_id") @db.Uuid
  warehouse     Warehouse      @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  
  brand         String         @db.VarChar(100)
  model         String         @db.VarChar(100)
  serialNumber  String?        @unique @map("serial_number") @db.VarChar(100)
  
  keysCount     Int            @default(88) @map("keys_count")
  hasMidi       Boolean        @default(true) @map("has_midi")
  hasBluetooth  Boolean        @default(false) @map("has_bluetooth")
  weightKg      Decimal?       @map("weight_kg") @db.Decimal(5, 2)
  
  dailyRate     Decimal        @map("daily_rate") @db.Decimal(10, 2)
  weeklyRate    Decimal?       @map("weekly_rate") @db.Decimal(10, 2)
  monthlyRate   Decimal?       @map("monthly_rate") @db.Decimal(10, 2)
  depositAmount Decimal        @default(0) @map("deposit_amount") @db.Decimal(10, 2)
  
  status        PianoStatus    @default(available)
  currentOrderId String?       @map("current_order_id") @db.Uuid
  
  images        Json           @default("[]") @db.JsonB
  condition     PianoCondition @default(good)
  
  avgRating     Decimal        @default(0) @map("avg_rating") @db.Decimal(2, 1)
  totalRentals  Int            @default(0) @map("total_rentals")
  
  createdAt     DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime       @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  orders        Order[]
  
  @@index([warehouseId])
  @@index([status])
  @@index([brand])
  @@map("pianos")
}

// ============================================
// ORDERS
// ============================================

enum OrderStatus {
  pending
  paid
  confirmed
  preparing
  shipping
  delivered
  active
  returning
  returned
  completed
  cancelled
}

enum PaymentStatus {
  pending
  paid
  refunded
  failed
}

model Order {
  id             String        @id @default(uuid()) @db.Uuid
  orderNumber    String        @unique @map("order_number") @db.VarChar(20)
  
  studentId      String        @map("student_id") @db.Uuid
  student        User          @relation("StudentOrders", fields: [studentId], references: [id])
  warehouseId    String        @map("warehouse_id") @db.Uuid
  warehouse      Warehouse     @relation(fields: [warehouseId], references: [id])
  pianoId        String        @map("piano_id") @db.Uuid
  piano          Piano         @relation(fields: [pianoId], references: [id])
  
  startDate      DateTime      @map("start_date") @db.Date
  endDate        DateTime      @map("end_date") @db.Date
  actualReturnDate DateTime?   @map("actual_return_date") @db.Date
  
  deliveryAddress String       @map("delivery_address") @db.Text
  deliveryLat    Decimal?      @map("delivery_lat") @db.Decimal(10, 8)
  deliveryLng    Decimal?      @map("delivery_lng") @db.Decimal(11, 8)
  deliveryDistanceKm Decimal?  @map("delivery_distance_km") @db.Decimal(6, 2)
  
  rentalDays     Int           @map("rental_days")
  dailyRate      Decimal       @map("daily_rate") @db.Decimal(10, 2)
  rentalAmount   Decimal       @map("rental_amount") @db.Decimal(12, 2)
  insuranceAmount Decimal      @default(0) @map("insurance_amount") @db.Decimal(10, 2)
  shippingAmount Decimal       @default(0) @map("shipping_amount") @db.Decimal(10, 2)
  discountAmount Decimal       @default(0) @map("discount_amount") @db.Decimal(10, 2)
  totalAmount    Decimal       @map("total_amount") @db.Decimal(12, 2)
  depositAmount  Decimal       @default(0) @map("deposit_amount") @db.Decimal(10, 2)
  
  paymentStatus  PaymentStatus @default(pending) @map("payment_status")
  paymentMethod  String?       @map("payment_method") @db.VarChar(20)
  paymentTransactionId String? @map("payment_transaction_id") @db.VarChar(100)
  paidAt         DateTime?     @map("paid_at") @db.Timestamptz(6)
  
  status         OrderStatus   @default(pending)
  
  shipperName    String?       @map("shipper_name") @db.VarChar(100)
  shipperPhone   String?       @map("shipper_phone") @db.VarChar(15)
  trackingCode   String?       @map("tracking_code") @db.VarChar(50)
  estimatedDelivery DateTime?  @map("estimated_delivery") @db.Timestamptz(6)
  deliveredAt    DateTime?     @map("delivered_at") @db.Timestamptz(6)
  
  referrerId     String?       @map("referrer_id") @db.Uuid
  commissionProcessed Boolean  @default(false) @map("commission_processed")
  
  customerNote   String?       @map("customer_note") @db.Text
  partnerNote    String?       @map("partner_note") @db.Text
  
  createdAt      DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  commissions    Commission[]
  
  @@index([studentId])
  @@index([warehouseId])
  @@index([pianoId])
  @@index([status])
  @@index([paymentStatus])
  @@index([referrerId])
  @@index([createdAt(sort: Desc)])
  @@map("orders")
}

// ============================================
// COMMISSIONS
// ============================================

enum CommissionStatus {
  pending
  approved
  paid
  cancelled
}

model Commission {
  id           String           @id @default(uuid()) @db.Uuid
  orderId      String           @map("order_id") @db.Uuid
  order        Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  affiliateId  String           @map("affiliate_id") @db.Uuid
  affiliate    User             @relation("AffiliateCommissions", fields: [affiliateId], references: [id])
  sourceUserId String           @map("source_user_id") @db.Uuid
  sourceUser   User             @relation("SourceCommissions", fields: [sourceUserId], references: [id])
  
  tier         Int
  orderAmount  Decimal          @map("order_amount") @db.Decimal(12, 2)
  commissionRate Decimal        @map("commission_rate") @db.Decimal(5, 2)
  commissionAmount Decimal      @map("commission_amount") @db.Decimal(12, 2)
  
  status       CommissionStatus @default(pending)
  walletTransactionId String?   @map("wallet_transaction_id") @db.Uuid
  
  createdAt    DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  approvedAt   DateTime?        @map("approved_at") @db.Timestamptz(6)
  paidAt       DateTime?        @map("paid_at") @db.Timestamptz(6)
  
  @@index([orderId])
  @@index([affiliateId])
  @@index([sourceUserId])
  @@index([tier])
  @@index([status])
  @@map("commissions")
}

// ============================================
// CLASS SESSIONS
// ============================================

enum SessionType {
  one_on_one
  group
  trial
}

enum SessionStatus {
  scheduled
  in_progress
  completed
  cancelled
  no_show
}

model ClassSession {
  id            String         @id @default(uuid()) @db.Uuid
  studentId     String         @map("student_id") @db.Uuid
  student       User           @relation("StudentSessions", fields: [studentId], references: [id])
  teacherId     String         @map("teacher_id") @db.Uuid
  teacher       User           @relation("TeacherSessions", fields: [teacherId], references: [id])
  
  scheduledAt   DateTime       @map("scheduled_at") @db.Timestamptz(6)
  durationMinutes Int          @default(60) @map("duration_minutes")
  actualStartAt DateTime?      @map("actual_start_at") @db.Timestamptz(6)
  actualEndAt   DateTime?      @map("actual_end_at") @db.Timestamptz(6)
  
  sessionType   SessionType    @default(one_on_one) @map("session_type")
  
  price         Decimal        @db.Decimal(10, 2)
  platformFee   Decimal        @default(0) @map("platform_fee") @db.Decimal(10, 2)
  teacherEarning Decimal       @map("teacher_earning") @db.Decimal(10, 2)
  
  paymentStatus PaymentStatus  @default(pending) @map("payment_status")
  status        SessionStatus  @default(scheduled)
  
  recordingUrl  String?        @map("recording_url") @db.VarChar(500)
  midiLogUrl    String?        @map("midi_log_url") @db.VarChar(500)
  roomId        String?        @map("room_id") @db.VarChar(100)
  
  referrerId    String?        @map("referrer_id") @db.Uuid
  commissionProcessed Boolean  @default(false) @map("commission_processed")
  
  teacherNotes  String?        @map("teacher_notes") @db.Text
  studentFeedback String?      @map("student_feedback") @db.Text
  rating        Int?
  
  createdAt     DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime       @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  @@index([studentId])
  @@index([teacherId])
  @@index([scheduledAt])
  @@index([status])
  @@map("class_sessions")
}

// ============================================
// TEACHER PROFILES
// ============================================

enum TeachingStyle {
  patient
  strict
  fun
  encouraging
}

model TeacherProfile {
  id           String         @id @default(uuid()) @db.Uuid
  userId       String         @unique @map("user_id") @db.Uuid
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  bio          String?        @db.Text
  videoIntroUrl String?       @map("video_intro_url") @db.VarChar(500)
  
  specialties  Json           @default("[]") @db.JsonB
  experienceYears Int         @default(0) @map("experience_years")
  education    String?        @db.Text
  certificates Json           @default("[]") @db.JsonB
  
  hourlyRate   Decimal        @map("hourly_rate") @db.Decimal(10, 2)
  trialRate    Decimal?       @map("trial_rate") @db.Decimal(10, 2)
  
  availableSlots Json         @default("[]") @map("available_slots") @db.JsonB
  teachingStyle TeachingStyle? @map("teaching_style")
  
  avgRating    Decimal        @default(0) @map("avg_rating") @db.Decimal(2, 1)
  totalStudents Int           @default(0) @map("total_students")
  totalSessions Int           @default(0) @map("total_sessions")
  totalHours   Int            @default(0) @map("total_hours")
  
  isVerified   Boolean        @default(false) @map("is_verified")
  isAcceptingStudents Boolean @default(true) @map("is_accepting_students")
  
  createdAt    DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime       @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  @@index([userId])
  @@index([avgRating(sort: Desc)])
  @@map("teacher_profiles")
}
