<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xpiano Classroom Hub</title>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #2d1b4e 100%);
      color: #fff;
      min-height: 100vh;
    }

    /* Landing */
    .landing {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    .landing h1 {
      font-size: 3rem;
      margin-bottom: 2rem;
      background: linear-gradient(45deg, #a855f7, #ec4899);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .role-buttons {
      display: flex;
      gap: 2rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    .role-btn {
      padding: 3rem 2rem;
      font-size: 1.5rem;
      border: 2px solid #a855f7;
      border-radius: 20px;
      background: rgba(168, 85, 247, 0.1);
      color: #fff;
      cursor: pointer;
      transition: all 0.3s;
      min-width: 250px;
      font-weight: 600;
    }

    .role-btn:hover {
      transform: translateY(-5px);
      background: rgba(168, 85, 247, 0.3);
      box-shadow: 0 10px 30px rgba(168, 85, 247, 0.4);
    }

    /* Chat Mode */
    .chat-mode {
      display: none;
      flex-direction: column;
      height: 100vh;
    }

    .chat-mode.active { display: flex; }

    .header {
      background: rgba(15, 15, 35, 0.95);
      padding: 1.5rem 2rem;
      border-bottom: 2px solid #a855f7;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #22c55e;
      display: inline-block;
      margin-right: 10px;
    }

    .status-dot.offline { background: #ef4444; }

    .start-btn {
      padding: 1rem 2rem;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      border: none;
      border-radius: 12px;
      color: #fff;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
    }

    .start-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 2rem;
      background: rgba(15, 15, 35, 0.5);
    }

    .message {
      margin-bottom: 1rem;
      display: flex;
    }

    .message.mine { justify-content: flex-end; }
    .message.theirs { justify-content: flex-start; }

    .message-bubble {
      max-width: 60%;
      padding: 1rem 1.5rem;
      border-radius: 20px;
    }

    .message.mine .message-bubble {
      background: linear-gradient(135deg, #a855f7, #9333ea);
      border-bottom-right-radius: 5px;
    }

    .message.theirs .message-bubble {
      background: rgba(255, 255, 255, 0.1);
      border-bottom-left-radius: 5px;
    }

    .system-msg {
      text-align: center;
      color: #9ca3af;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      margin: 1rem 0;
    }

    .ping-indicator {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(0, 0, 0, 0.8);
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .ping-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #22c55e;
      animation: pulse 2s infinite;
    }

    .ping-dot.warning { background: #f59e0b; }
    .ping-dot.danger { background: #ef4444; }

    .call-popup {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeIn 0.3s;
    }

    .call-popup.show { display: flex; }

    .call-popup-content {
      background: linear-gradient(135deg, #1a1a2e 0%, #2d1b4e 100%);
      border: 2px solid #a855f7;
      border-radius: 20px;
      padding: 3rem;
      max-width: 400px;
      text-align: center;
      animation: slideUp 0.3s;
    }

    .call-popup-icon {
      font-size: 5rem;
      margin-bottom: 1rem;
      animation: bounce 1s infinite;
    }

    .call-popup-buttons {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }

    .call-popup-btn {
      flex: 1;
      padding: 1rem;
      border: none;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .call-popup-btn:hover {
      transform: scale(1.05);
    }

    .accept-btn {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
    }

    .reject-btn {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .input-area {
      padding: 1.5rem 2rem;
      background: rgba(15, 15, 35, 0.95);
      border-top: 2px solid #a855f7;
      display: flex;
      gap: 1rem;
    }

    .chat-input {
      flex: 1;
      padding: 1rem 1.5rem;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(168, 85, 247, 0.3);
      border-radius: 25px;
      color: #fff;
      font-size: 1rem;
      outline: none;
    }

    .send-btn {
      padding: 1rem 2rem;
      background: linear-gradient(135deg, #a855f7, #ec4899);
      border: none;
      border-radius: 25px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }

    /* Lesson Mode */
    .lesson-mode {
      display: none;
      grid-template-columns: 70% 30%;
      gap: 1rem;
      padding: 1rem;
      height: 100vh;
    }

    .lesson-mode.active { display: grid; }

    .piano-area {
      background: #000;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid #a855f7;
      font-size: 2rem;
      color: #666;
    }

    .video-area {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .video-box {
      background: rgba(15, 15, 35, 0.8);
      border-radius: 16px;
      border: 2px solid #a855f7;
      overflow: hidden;
      position: relative;
      flex: 1;
    }

    .video-box video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .video-label {
      position: absolute;
      top: 1rem;
      left: 1rem;
      background: rgba(0, 0, 0, 0.8);
      padding: 0.5rem 1rem;
      bdiv style="display: flex; gap: 1rem; align-items: center;">
        <div id="pingDisplay" style="display: none; color: #22c55e; font-size: 0.9rem;">
          <span class="ping-dot"></span>
          <span id="pingValue">-- ms</span>
        </div>
        <button class="start-btn" id="startBtn" onclick="requestStartLesson()" disabled>
          ğŸ¹ Báº®T Äáº¦U BUá»”I Há»ŒC
        </button>
      </div

    .controls {
      background: rgba(15, 15, 35, 0.8);
      border-radius: 16px;
      border: 2px solid #a855f7;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .end-btn {
      padding: 1rem;
      background: linear-gradient(135deg, #ef4444, #dc2626);
      border: none;
      border-radius: 12px;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
    }

    .video-controls {
      position: absolute;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 0.5rem;
    }

    .video-ctrl-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      cursor: pointer;
      font-size: 1.2rem;
    }

    .loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .loading.show { display: flex; }

    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(168, 85, 247, 0.3);
      border-top: 4px solid #a855f7;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 1024px) {
      .lesson-mode.active {
        grid-template-columns: 1fr;
        grid-template-rows: 65% 35%;
      }
      .video-area { flex-direction: row; }
    }
  </style>
</head>
<body>

  <!-- Landing -->
  <div class="landing" id="landing">
    <h1>ğŸ¹ Xpiano Classroom Hub</h1>
    <div class="role-buttons">
      <button class="role-btn" onclick="selectRole('teacher')">
        ğŸ‘¨â€ğŸ«<br>GiÃ¡o ViÃªn
      </button>
      <button class="role-btn" onclick="selectRole('student')">
        ğŸ“<br>Há»c ViÃªn
      </button>
    </div>
  </div>

  <!-- Chat Mode -->
  <div class="chat-mode" id="chatMode">
    <div class="header">
      <div>
        <span class="status-dot" id="statusDot"></span>
        <span id="partnerName">Äang káº¿t ná»‘i...</span>
      </div>
      <div style="display: flex; gap: 1rem; align-items: center;">
        <div id="pingDisplay" style="display: none; color: #22c55e; font-size: 0.9rem; align-items: center; gap: 0.5rem;">
          <div class="ping-dot"></div>
          <span id="pingValue">-- ms</span>
        </div>
        <button class="start-btn" id="startBtn" onclick="requestStartLesson()" disabled>
          ğŸ¹ Báº®T Äáº¦U BUá»”I Há»ŒC
        </button>
      </div>
    </div>
    <div class="messages" id="messages"></div>
    <div class="input-area">
      <input type="text" class="chat-input" id="chatInput" placeholder="Nháº­p tin nháº¯n..." onkeypress="if(event.key==='Enter')sendMessage()">
      <button class="send-btn" onclick="sendMessage()">Gá»­i</button>
    </div>
  </div>

  <!-- Lesson Mode -->
  <div class="lesson-mode" id="lessonMode">
    <div class="piano-area">
      ğŸ¹ğŸ¼<br>Piano Placeholder
    </div>
    <div class="video-area">
      <div class="video-box" style="flex: 1.5;">
        <video id="remoteVideo" autoplay playsinline></video>
        <div class="video-label">Äá»‘i phÆ°Æ¡ng</div>
      </div>
      <div class="video-box">
        <video id="localVideo" autoplay muted playsinline></video>
        <div class="video-label">Báº¡n</div>
        <div class="video-controls">
          <button class="video-ctrl-btn" onclick="toggleMute()">ğŸ¤</button>
          <button class="video-ctrl-btn" onclick="toggleCamera()">ğŸ“¹</button>
        </div>
      </div>
      <div class="controls">
        <button class="end-btn" onclick="endLesson()">ğŸšª Káº¾T THÃšC</button>
      </div>
    </div>
  </div>

  <!-- L

  <!-- Call Request Popup -->
  <div class="call-popup" id="callPopup">
    <div class="call-popup-content">
      <div class="call-popup-icon">ğŸ“</div>
      <h2 style="font-size: 1.8rem; margin-bottom: 0.5rem;">YÃªu cáº§u vÃ o há»c</h2>
      <p style="color: #9ca3af; font-size: 1.1rem;" id="callerName">
        Äang chá»...
      </p>
      <div class="call-popup-buttons">
        <button class="call-popup-btn reject-btn" onclick="rejectLesson()">
          âŒ Tá»« chá»‘i
        </button>
        <button class="call-popup-btn accept-btn" onclick="acceptLesson()">
          âœ… Cháº¥p nháº­n
        </button>
      </div>
    </div>
  </div>oading -->
  <div class="loading" id="loading">
    <div>
      <div class="spinner"></div>
      <div style="text-align: center; margin-top: 1rem;">Äang káº¿t ná»‘i...</div>
    </div>
  </div>

  <script>
    let peer, conn, call, localStream;
    let myRole, myId, partnerId;
    let isConnected = false;
    let pingInterval;
    let lastPing = 0;

    function selectRole(role) {
      myRole = role;
      myId = role === 'teacher' ? 'xpiano-teacher-demo' : 'xpiano-student-demo';
      partnerId = role === 'teacher' ? 'xpiano-student-demo' : 'xpiano-teacher-demo';

      document.getElementById('landing').style.display = 'none';
      document.getElementById('chatMode').classList.add('active');
      
      const partnerName = role === 'teacher' ? 'ğŸ“ Há»c viÃªn' : 'ğŸ‘¨â€ğŸ« GiÃ¡o viÃªn';
      document.getElementById('partnerName').textContent = partnerName;

      initPeer();
    }

    function initPeer() {
      showLoading();

      peer = new Peer(myId, {
        host: '0.peerjs.com',
        secure: true,
        port: 443,
        path: '/',
        debug: 1
      });

      peer.on('open', (id) => {
        console.log('Connected with ID:', id);
        hideLoading();
        addSystemMsg('âœ… ÄÃ£ online! Äang chá» Ä‘á»‘i phÆ°Æ¡ng...');
        connectToPartner();
      });

      peer.on('connection', (c) => {
        conn = c;
        setupConnection();
      });

      peer.on('call', (incomingCall) => {
        console.log('Receiving call from partner...');
        
        // Prevent multiple calls
        if (call) {
          console.log('Already in a call, ignoring');
          return;
        }
        
        call = incomingCall;
        
        // Get stream then answer
        if (!localStream) {
          showLoading();
          navigator.mediaDevices.getUserMedia({
            video: { width: 1280, height: 720 },
            audio: { echoCancellation: true, noiseSuppression: true }
          }).then(stream => {
            localStream = stream;
            document.getElementById('localVideo').srcObject = stream;
            
            // Answer the call
            incomingCall.answer(stream);
            console.log('âœ… Answered call with stream');
            
            // Switch to lesson mode
            document.getElementById('chatMode').classList.remove('active');
            document.getElementById('lessonMode').classList.add('active');
            hideLoading();
          }).catch(err => {
            console.error('Failed to get media:', err);
            alert('KhÃ´ng thá»ƒ truy cáº­p camera/mic: ' + err.message);
            hideLoading();
          });
        } else {
          // Already have stream
          incomingCall.answer(localStream);
          console.log('âœ… Answered call with existing stream');
        }
        
        // Listen for remote stream
        incomingCall.on('stream', (remoteStream) => {
          console.log('âœ… Received remote stream');
          document.getElementById('remoteVideo').srcObject = remoteStream;
        });
        
        incomingCall.on('close', () => {
          console.log('Call closed by remote');
          call = null;
        });
        
        incomingCall.on('error', (err) => {
          console.error('Incoming call error:', err);
        });
      });

      peer.on('disconnected', () => {
        console.warn('Peer disconnected, attempting to reconnect...');
        if (!peer.destroyed) {
          peer.reconnect();
        }
      });

      peer.on('error', (err) => {
        console.error('Peer error:', err);
        hideLoading();
        if (err.type === 'unavailable-id') {
          alert('âš ï¸ ID Ä‘Ã£ Ä‘Æ°á»£c sá»­ dá»¥ng!\n\nÄÃ³ng tab khÃ¡c vÃ  refresh trang nÃ y.');
        } else if (err.type === 'disconnected') {
          // Thá»­ reconnect
          setTimeout(() => {
            if (peer && !peer.destroyed) {
              peer.reconnect();
            }
          }, 1000);
        }
      });
    }

    function connectToPartner() {
      const interval = setInterval(() => {
        if (isConnected || !peer) {
          clearInterval(interval);
          return;
        }

        try {
          conn = peer.connect(partnerId, { reliable: true });
          
          conn.on('open', () => {
            clearInterval(interval);
            setupConnection();
          });
        } catch (e) {
          console.log('Connect attempt failed');
        }
      }, 2000);

      setTimeout(() => clearInterval(interval), 300000);
    }

    function setupConnection() {
      isConnected = true;
      document.getElementById('statusDot').classList.remove('offline');
      document.getElementById('startBtn').disabled = false;
      addSystemMsg('ğŸ‰ ÄÃ£ káº¿t ná»‘i vá»›i Ä‘á»‘i phÆ°Æ¡ng!');
      
      // Báº¯t Ä‘áº§u ping
      startPing();

      conn.on('data', (data) => {
        if (data.type === 'message') {
          addMessage(data.text, false);
        } else if (data.type === 'start-lesson-request') {
          // Hiá»ƒn thá»‹ popup yÃªu cáº§u vÃ o há»c
          showCallPopup(data.sender);
        } else if (data.type === 'start-lesson-accepted') {
          // NgÆ°á»i gá»­i nháº­n Ä‘Æ°á»£c accept â†’ Báº¯t Ä‘áº§u buá»•i há»c
          console.log('Partner accepted, starting lesson...');
          addSystemMsg('âœ… Äá»‘i phÆ°Æ¡ng Ä‘Ã£ cháº¥p nháº­n!');
          startLesson();
        } else if (data.type === 'start-lesson-rejected') {
          // NgÆ°á»i gá»­i nháº­n Ä‘Æ°á»£c reject
          alert('âŒ ' + data.sender + ' Ä‘Ã£ tá»« chá»‘i yÃªu cáº§u vÃ o há»c!');
          document.getElementById('startBtn').disabled = false;
        } else if (data.type === 'ping') {
          // Tráº£ lá»i ping
          conn.send({ type: 'pong', timestamp: data.timestamp });
        } else if (data.type === 'pong') {
          // TÃ­nh latency
          const latency = Date.now() - data.timestamp;
          lastPing = latency;
          updatePingDisplay(latency);
        } else if (data.type === 'end-lesson') {
          endLesson();
        }
      });

      conn.on('close', () => {
        isConnected = false;
        document.getElementById('statusDot').classList.add('offline');
        document.getElementById('startBtn').disabled = true;
        addSystemMsg('âš ï¸ Äá»‘i phÆ°Æ¡ng Ä‘Ã£ ngáº¯t káº¿t ná»‘i');
      });
    }

    function sendMessage() {
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      
      if (!text || !conn) return;

      conn.send({ type: 'message', text: text });
      addMessage(text, true);
      input.value = '';
    }

    function addMessage(text, isMine) {
      const div = document.createElement('div');
      div.className = `message ${isMine ? 'mine' : 'theirs'}`;
      div.innerHTML = `<div class="message-bubble">${text}</div>`;
      document.getElementById('messages').appendChild(div);
      document.getElementById('messages').scrollTop = 999999;
    }

    function addSystemMsg(text) {
      const div = document.createElement('div');
      div.className = 'system-msg';
      div.textContent = text;
      document.getElementById('messages').appendChild(div);
      document.getElementById('messages').scrollTop = 999999;
    }

    function requestStartLesson() {
      if (!isConnected || !conn) {
        alert('âš ï¸ ChÆ°a káº¿t ná»‘i vá»›i Ä‘á»‘i tÃ¡c!');
        return;
      }

      // Gá»­i yÃªu cáº§u báº¯t Ä‘áº§u buá»•i há»c
      conn.send({
        type: 'start-lesson-request',
        sender: myRole === 'teacher' ? 'GiÃ¡o viÃªn' : 'Há»c viÃªn'
      });
      
      document.getElementById('startBtn').disabled = true;
      addSystemMsg('ğŸ“ ÄÃ£ gá»­i yÃªu cáº§u vÃ o há»c...');
    }

    function showCallPopup(senderName) {
      document.getElementById('callerName').textContent = senderName + ' muá»‘n báº¯t Ä‘áº§u buá»•i há»c';
      document.getElementById('callPopup').classList.add('show');
    }

    function acceptLesson() {
      document.getElementById('callPopup').classList.remove('show');
      
      // Gá»­i signal accept
      conn.send({
        type: 'start-lesson-accepted',
        sender: myRole === 'teacher' ? 'GiÃ¡o viÃªn' : 'Há»c viÃªn'
      });
      
      // Báº¯t Ä‘áº§u buá»•i há»c
      addSystemMsg('âœ… ÄÃ£ cháº¥p nháº­n yÃªu cáº§u!');
      startLesson();
    }

    function rejectLesson() {
      document.getElementById('callPopup').classList.remove('show');
      
      // Gá»­i signal reject
      conn.send({
        type: 'start-lesson-rejected',
        sender: myRole === 'teacher' ? 'GiÃ¡o viÃªn' : 'Há»c viÃªn'
      });
      
      addSystemMsg('âŒ ÄÃ£ tá»« chá»‘i yÃªu cáº§u vÃ o há»c');
    }

    function acceptLesson() {
      document.getElementById('callPopup').classList.remove('show');
      
      // Gá»­i signal accept
      conn.send({
        type: 'start-lesson-accepted',
        sender: myRole === 'teacher' ? 'GiÃ¡o viÃªn' : 'Há»c viÃªn'
      });
      
      // Báº¯t Ä‘áº§u buá»•i há»c
      startLesson();
    }

    function rejectLesson() {
      document.getElementById('callPopup').classList.remove('show');
      
      // Gá»­i signal reject
      conn.send({
        type: 'start-lesson-rejected',
        sender: myRole === 'teacher' ? 'GiÃ¡o viÃªn' : 'Há»c viÃªn'
      });
      
      addMessage('âŒ ÄÃ£ tá»« chá»‘i yÃªu cáº§u vÃ o há»c', 'system');
    }

    async function startLesson() {
      if (conn) conn.send({ type: 'start-lesson' });

      showLoading();

      try {
        // Get local stream
        localStream = await navigator.mediaDevices.getUserMedia({
          video: { width: 1280, height: 720 },
          audio: { echoCancellation: true, noiseSuppression: true }
        });

        document.getElementById('localVideo').srcObject = localStream;

        // Switch to lesson mode first
        document.getElementById('chatMode').classList.remove('active');
        document.getElementById('lessonMode').classList.add('active');

        // Only TEACHER makes the call, STUDENT just waits
        if (myRole === 'teacher') {
          // Check peer connection
          if (!peer || peer.destroyed || peer.disconnected) {
            console.error('Peer is not connected. Reinitializing...');
            hideLoading();
            alert('âš ï¸ Máº¥t káº¿t ná»‘i vá»›i server. Vui lÃ²ng refresh trang!');
            return;
          }

          // Wait a bit for student to be ready
          setTimeout(() => {
            if (partnerId && !call) {
              console.log('Teacher calling student:', partnerId);
              call = peer.call(partnerId, localStream);
              
              if (call) {
                call.on('stream', (s) => {
                  console.log('Teacher received student stream');
                  document.getElementById('remoteVideo').srcObject = s;
                });
                
                call.on('error', (err) => {
                  console.error('Call error:', err);
                  alert('âŒ Lá»—i khi gá»i video: ' + err.message);
                });
              }
            }
          }, 1000);
        } else {
          console.log('Student waiting for teacher call...');
          // Student just waits for incoming call (handled in peer.on('call'))
        }
        
        hideLoading();
      } catch (err) {
        hideLoading();
        console.error('Camera/Mic error:', err);
        
        let errorMsg = 'KhÃ´ng thá»ƒ truy cáº­p camera/mic:\n\n';
        
        if (err.name === 'NotAllowedError' || err.message.includes('Permission denied')) {
          errorMsg += 'âŒ Windows Ä‘ang cháº·n quyá»n truy cáº­p!\n\n';
          errorMsg += 'âœ… CÃ¡ch sá»­a:\n';
          errorMsg += '1. Má»Ÿ Windows Settings â†’ Privacy â†’ Camera\n';
          errorMsg += '2. Báº­t "Let apps access your camera"\n';
          errorMsg += '3. Báº­t "Let desktop apps access your camera"\n';
          errorMsg += '4. LÃ m tÆ°Æ¡ng tá»± cho Microphone\n';
          errorMsg += '5. Refresh trang nÃ y\n\n';
          errorMsg += 'âš ï¸ Hoáº·c thá»­ trÃªn localhost:3000 thay vÃ¬ ngrok';
        } else if (err.name === 'NotFoundError') {
          errorMsg += 'âŒ KhÃ´ng tÃ¬m tháº¥y camera/microphone!';
        } else {
          errorMsg += err.message;
        }
        
        alert(errorMsg);
        document.getElementById('lessonMode').classList.remove('active');
        document.getElementById('chatMode').classList.add('active');
      }
    }

    function endLesson() {
      if (conn) conn.send({ type: 'end-lesson' });

      if (localStream) {
        localStream.getTracks().forEach(t => t.stop());
        localStream = null;
      }

      if (call) {
        call.close();
        call = null;
      }
      
      // Dá»«ng ping
      if (pingInterval) {
        clearInterval(pingInterval);
        pingInterval = null;
      }

      document.getElementById('localVideo').srcObject = null;
      document.getElementById('remoteVideo').srcObject = null;

      document.getElementById('lessonMode').classList.remove('active');
      document.getElementById('chatMode').classList.add('active');
      
      document.getElementById('startBtn').disabled = false;

      addSystemMsg('ğŸ“´ ÄÃ£ káº¿t thÃºc buá»•i há»c');
    }

    function toggleMute() {
      if (localStream) {
        const track = localStream.getAudioTracks()[0];
        if (track) track.enabled = !track.enabled;
      }
    }

    function toggleCamera() {
      if (localStream) {
        const track = localStream.getVideoTracks()[0];
        if (track) track.enabled = !track.enabled;
      }
    }

    function showLoading() {
      document.getElementById('loading').classList.add('show');
    }

    function hideLoading() {
      document.getElementById('loading').classList.remove('show');
    }
    
    function startPing() {
      // Gá»­i ping má»—i 2 giÃ¢y
      if (pingInterval) clearInterval(pingInterval);
      
      const pingDisplay = document.getElementById('pingDisplay');
      if (pingDisplay) {
        pingDisplay.style.display = 'flex';
      }
      
      pingInterval = setInterval(() => {
        if (conn && conn.open) {
          conn.send({ type: 'ping', timestamp: Date.now() });
        }
      }, 2000);
    }

    function updatePingDisplay(latency) {
      const pingValue = document.getElementById('pingValue');
      const pingDot = document.querySelector('#pingDisplay .ping-dot');
      const remotePingValue = document.getElementById('remotePingValue');
      const remotePingDot = document.getElementById('remotePingDot');
      
      if (pingValue) {
        pingValue.textContent = latency + ' ms';
      }
      
      if (remotePingValue) {
        remotePingValue.textContent = latency + ' ms';
      }
      
      // Cáº­p nháº­t mÃ u dá»±a trÃªn latency
      const dotClass = latency < 100 ? '' : (latency < 200 ? 'warning' : 'danger');
      
      if (pingDot) {
        pingDot.className = 'ping-dot ' + dotClass;
      }
      
      if (remotePingDot) {
        remotePingDot.className = 'ping-dot ' + dotClass;
      }
    }

    window.addEventListener('beforeunload', () => {
      if (localStream) localStream.getTracks().forEach(t => t.stop());
      if (call) call.close();
      if (conn) conn.close();
      if (peer) peer.destroy();
    });
  </script>

</body>
</html>